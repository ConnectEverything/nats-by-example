<!doctype html>
<html>
<head>
	<title>NATS by Example</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="/nats.svg" />
<link rel="stylesheet" href="/reset.css">
<link rel="stylesheet" href="/main.css">


<script async src="https://www.googletagmanager.com/gtag/js?id=G-9QV780SHZ5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-9QV780SHZ5');
</script>

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:creator" content="@thedevel" />
  <meta name="twitter:title" content="Programmatic NKeys and JWTs in Authentication and Authorization" />
  <meta name="twitter:description" content="The primary (and recommended) way to create and manage accounts and users
is using the nsc command-line tool. However,
in some applications and use cases, it may be desirable to programmatically
create accounts or users on-demand as part of an application-level account/user
workflow rather than out-of-band on the command line (however, shelling out
to nsc from your program is another option).

This example shows how to programmatically generate NKeys and JWTs.
This can be used as an alternative or, more likely, in conjunction with the
nsc tool for creating and managing accounts and users.

Note, not all languages currently implement standalone NKeys or JWT libraries.
" />
  <meta name="twitter:image" content="https://natsbyexample.com/nbe-twitter.png" />
  <meta name="twitter:image:alt" content="NATS by Example" />

  <link rel="stylesheet" type="text/css" href="/asciinema-player.css" />
</head>
<body>
  <header>
    <div class="container">
      <h1 id="header">
  <a href="/">
    <img src="/nats-horizontal-color.svg" alt="NATS Logo" /> by Example
  </a>
</h1>

    </div>
  </header>

  <main>
    <div class="container">
      <h2 class="title">Programmatic NKeys and JWTs <small class="quiet">in Authentication and Authorization</small></h2>

      <div class="description">
      <p>The primary (and recommended) way to create and manage accounts and users
is using the <a href="https://nats-io.github.io/nsc/">nsc</a> command-line tool. However,
in some applications and use cases, it may be desirable to programmatically
create accounts or users on-demand as part of an application-level account/user
workflow rather than out-of-band on the command line (however, shelling out
to <code>nsc</code> from your program is another option).</p>

<p>This example shows how to programmatically generate NKeys and JWTs.
This can be used as an alternative or, more likely, in conjunction with the
nsc tool for creating and managing accounts and users.</p>

<p><em>Note, not all languages currently implement standalone NKeys or JWT libraries.</em></p>

      </div>

      

      <div class="info">
        <div class="language-tabs">
          
          
          <span class="inactive" title="Not yet implemented">CLI</span>
          
          
          
          <span class="active">Go</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Python</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Deno</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Node</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Rust</span>
          
          
          
          <span class="inactive" title="Not yet implemented">C#</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Java</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Ruby</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Elixir</span>
          
          
          
          <span class="inactive" title="Not yet implemented">C</span>
          
          
        </div>

        <div class="source-run">
          <div class="links">
            <img class="github-icon" src="/github-mark.svg" alt="GitHub Mark"/>
            <a href="https://github.com/bruth/nats-by-example/tree/main/examples/auth/nkeys-jwts/go" target=_blank>Source code</a>
          </div>
          <pre>$ nbe run auth/nkeys-jwts/go</pre>
          <small><a target=_blank href="https://github.com/bruth/nats-by-example/#getting-started">Learn</a> how to run this example.</small>
        </div>
      </div>

      <div class="highlight">Check out a <a href="#recording">recording</a> of the code executing and the <a href="#output">output</a> below!</div>

      <h3 id="code">Code</h3>

      <div class="example">
      
      
        <div class="example-comment">
        
        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/nats-io/jwt/v2&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/nats-io/nkeys&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">SetFlags</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Create a one-off operator keypair for the purpose of this example.
In practice, the operator needs to be created ahead of time to configure
the resolver in the server config if you are deploying your own NATS server.
This most commonly done using the &ldquo;nsc&rdquo; tool:</p>

<pre><code>nsc add operator --generate-signing-key --sys --name local
nsc edit operator --require-signing-keys --account-jwt-server-url nats://127.0.0.1:4222
</code></pre>

<p>Signing keys are technically optional, but a best practice.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">	<span class="nx">operatorKP</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">nkeys</span><span class="p">.</span><span class="nf">CreateOperator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>We can distinguish operators, accounts, and users by the first character
of their public key: O, A, or U.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">	<span class="nx">operatorPub</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">operatorKP</span><span class="p">.</span><span class="nf">PublicKey</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;operator pubkey: %s\n&#34;</span><span class="p">,</span> <span class="nx">operatorPub</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Seed values (private key), are prefixed with S.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">	<span class="nx">operatorSeed</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">operatorKP</span><span class="p">.</span><span class="nf">Seed</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;operator seed: %s\n\n&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">operatorSeed</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>To create accounts on demand, we start with creatinng a new keypair which
has a unique ID.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">	<span class="nx">accountKP</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">nkeys</span><span class="p">.</span><span class="nf">CreateAccount</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">accountPub</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">accountKP</span><span class="p">.</span><span class="nf">PublicKey</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;account pubkey: %s\n&#34;</span><span class="p">,</span> <span class="nx">accountPub</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">accountSeed</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">accountKP</span><span class="p">.</span><span class="nf">Seed</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;account seed: %s\n&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">accountSeed</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Create a new set of account claims and configure as desired including a
readable name, JetStream limits, imports/exports, etc.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">	<span class="nx">accountClaims</span> <span class="o">:=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nf">NewAccountClaims</span><span class="p">(</span><span class="nx">accountPub</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">accountClaims</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="s">&#34;my-account&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>The only requirement to &ldquo;enable&rdquo; JetStream is setting the disk and memory
limits to anything other than zero. -1 indicates &ldquo;unlimited&rdquo;.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">	<span class="nx">accountClaims</span><span class="p">.</span><span class="nx">Limits</span><span class="p">.</span><span class="nx">JetStreamLimits</span><span class="p">.</span><span class="nx">DiskStorage</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="nx">accountClaims</span><span class="p">.</span><span class="nx">Limits</span><span class="p">.</span><span class="nx">JetStreamLimits</span><span class="p">.</span><span class="nx">MemoryStorage</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Inspecting the claims, you will notice the <code>sub</code> field is the public key
of the account.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;account claims: %s\n&#34;</span><span class="p">,</span> <span class="nx">accountClaims</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Now we can sign the claims with the operator and encode it to a JWT string.
To activate this account, it must be pushed up to the server using a client
connection authenticated as the SYS account user:</p>

<pre><code class="language-go">nc.Request(&quot;$SYS.REQ.CLAIMS.UPDATE&quot;, []byte(accountJWT))
</code></pre>

<p>If you copy the JWT output to <a href="https://jwt.io">https://jwt.io</a>, you will notice the <code>iss</code>
field is set to the operator public key.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">	<span class="nx">accountJWT</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">accountClaims</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">operatorKP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;account jwt: %s\n\n&#34;</span><span class="p">,</span> <span class="nx">accountJWT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>It is important to call out that the nsc tool handles storage and management
of operators, accounts, users. It writes out each nkey and JWT to a file and
organizes everything for you. If you opt to create accounts or users dynamically,
keep in mind you need to store and manage the keypairs and JWTs yourself.</p>

<p>If we want to create a user, the process is essentially the same as it was
for the account.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">	<span class="nx">userKP</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">nkeys</span><span class="p">.</span><span class="nf">CreateUser</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">userPub</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">userKP</span><span class="p">.</span><span class="nf">PublicKey</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;user pubkey: %s\n&#34;</span><span class="p">,</span> <span class="nx">userPub</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">userSeed</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">userKP</span><span class="p">.</span><span class="nf">Seed</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;user seed: %s\n&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">userSeed</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Create the user claims, set the name, and configure permissions, expiry time,
limits, etc.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">	<span class="nx">userClaims</span> <span class="o">:=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nf">NewUserClaims</span><span class="p">(</span><span class="nx">userPub</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">userClaims</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="s">&#34;my-user&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;userclaims: %s\n&#34;</span><span class="p">,</span> <span class="nx">userClaims</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Sign and encode the claims as a JWT.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">	<span class="nx">userJWT</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">userClaims</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">accountKP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;user jwt: %s\n&#34;</span><span class="p">,</span> <span class="nx">userJWT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
        </div>
      
      
      </div>

      <h3 id="recording">Recording</h3>
      <div class="quiet text-center">Note, playback is 1/5 the speed to make it a bit easier to follow.</div>
      <div id="asciinema"></div>

      <h3 id="output">Output</h3>

      <pre class="output">Network 5f3c810c_default  Creating
Network 5f3c810c_default  Created
Container 5f3c810c-nats-1  Creating
Container 5f3c810c-nats-1  Created
Container 5f3c810c-nats-1  Starting
Container 5f3c810c-nats-1  Started
operator pubkey: OBM5R45XP7LDVHIBIJYWSQVRQNMIH6PAD2JJGTUVZ65NCNNL2XL2BEDH
operator seed: SOAB5V4E5FRLQAA6ATEEYFK7CSCP2HVW2G7I7P66WM6GVX2WPZDH7PLYGQ

account pubkey: AD4ZSLQA4TF6BQEHJOGYSVYO5GQRPRTBJWZNU37CE6NMMT6M6KU3F6AJ
account seed: SAAEFLXYQ4UFT6VSV345TGC3KYSV7PTWY6W3LQ3Q3L4M75WIKZHN4QGFRA
account claims: {
  &#34;name&#34;: &#34;my-account&#34;,
  &#34;sub&#34;: &#34;AD4ZSLQA4TF6BQEHJOGYSVYO5GQRPRTBJWZNU37CE6NMMT6M6KU3F6AJ&#34;,
  &#34;nats&#34;: {
    &#34;limits&#34;: {
      &#34;subs&#34;: -1,
      &#34;data&#34;: -1,
      &#34;payload&#34;: -1,
      &#34;imports&#34;: -1,
      &#34;exports&#34;: -1,
      &#34;wildcards&#34;: true,
      &#34;conn&#34;: -1,
      &#34;leaf&#34;: -1,
      &#34;mem_storage&#34;: -1,
      &#34;disk_storage&#34;: -1
    },
    &#34;default_permissions&#34;: {
      &#34;pub&#34;: {},
      &#34;sub&#34;: {}
    }
  }
}
account jwt: eyJ0eXAiOiJKV1QiLCJhbGciOiJlZDI1NTE5LW5rZXkifQ.eyJqdGkiOiJJUFZUNEVQWEVVRTNXUVVDN1RaUlEyWlczRTNPTTRZQU03UlBVM1dYVUU1SVFBWFVaN0tBIiwiaWF0IjoxNjU4MTQ3MjEzLCJpc3MiOiJPQk01UjQ1WFA3TERWSElCSUpZV1NRVlJRTk1JSDZQQUQySkpHVFVWWjY1TkNOTkwyWEwyQkVESCIsIm5hbWUiOiJteS1hY2NvdW50Iiwic3ViIjoiQUQ0WlNMUUE0VEY2QlFFSEpPR1lTVllPNUdRUlBSVEJKV1pOVTM3Q0U2Tk1NVDZNNktVM0Y2QUoiLCJuYXRzIjp7ImxpbWl0cyI6eyJzdWJzIjotMSwiZGF0YSI6LTEsInBheWxvYWQiOi0xLCJpbXBvcnRzIjotMSwiZXhwb3J0cyI6LTEsIndpbGRjYXJkcyI6dHJ1ZSwiY29ubiI6LTEsImxlYWYiOi0xLCJtZW1fc3RvcmFnZSI6LTEsImRpc2tfc3RvcmFnZSI6LTF9LCJkZWZhdWx0X3Blcm1pc3Npb25zIjp7InB1YiI6e30sInN1YiI6e319LCJ0eXBlIjoiYWNjb3VudCIsInZlcnNpb24iOjJ9fQ.wRcrk8sNjZytXc4ndJPi0t6aUs-6s-HW06rsnWVj6lt2JDq96G_Avay-jQ1KVvhUv6UVpclSeFsPD7NNsEW0Dg

user pubkey: UA7NAURVQHENYVCWE5TMCRUNW5CG3U7J77Y3TFEUMR7HCGSRVO6PNVX5
user seed: SUAEV2MKYN43G5YMU4MAKBHYHCOAIYCJZYKAMVUUS774ERWMB76N2SL5VM
userclaims: {
  &#34;name&#34;: &#34;my-user&#34;,
  &#34;sub&#34;: &#34;UA7NAURVQHENYVCWE5TMCRUNW5CG3U7J77Y3TFEUMR7HCGSRVO6PNVX5&#34;,
  &#34;nats&#34;: {
    &#34;pub&#34;: {},
    &#34;sub&#34;: {},
    &#34;subs&#34;: -1,
    &#34;data&#34;: -1,
    &#34;payload&#34;: -1
  }
}
user jwt: eyJ0eXAiOiJKV1QiLCJhbGciOiJlZDI1NTE5LW5rZXkifQ.eyJqdGkiOiJCSVNOSkJUS0NHSEZKNTVMSFRLUklOSEpIRlRLRUdPVFdQQVhRSkpBQzNGSFFJWEtJQVNRIiwiaWF0IjoxNjU4MTQ3MjEzLCJpc3MiOiJBRDRaU0xRQTRURjZCUUVISk9HWVNWWU81R1FSUFJUQkpXWk5VMzdDRTZOTU1UNk02S1UzRjZBSiIsIm5hbWUiOiJteS11c2VyIiwic3ViIjoiVUE3TkFVUlZRSEVOWVZDV0U1VE1DUlVOVzVDRzNVN0o3N1kzVEZFVU1SN0hDR1NSVk82UE5WWDUiLCJuYXRzIjp7InB1YiI6e30sInN1YiI6e30sInN1YnMiOi0xLCJkYXRhIjotMSwicGF5bG9hZCI6LTEsInR5cGUiOiJ1c2VyIiwidmVyc2lvbiI6Mn19.Z2RdkEUQrnKo4IE2w1F84XH44K_4kMhZSh4-OvUxNui2hYBnNO0R50DhtVbqCYprD1m1x1XZYc84O1GCTfz5Bg
</pre>

    </div>
  </main>
  <script src="/main.js" async></script>
  <script src="/asciinema-player.min.js"></script>
  <script>
    var url = '/examples\/auth\/nkeys-jwts\/go\/output.cast';
    AsciinemaPlayer.create(url, document.getElementById('asciinema'), {
      cols: 120,
      rows: 24,
      fit: false,
      
      speed: 0.2,
      terminalFontSize: "14px",
      terminalFontFamily: "'Roboto Mono', 'JetBrains Mono', 'Source Code Pro', 'FreeMono', monospace",
      terminalFontHeight: 1.4,
    });
  </script>
  <footer>
  </footer>
</body>
</html>

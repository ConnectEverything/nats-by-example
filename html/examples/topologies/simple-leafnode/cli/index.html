<!doctype html>
<html>
<head>
	<title>NATS by Example</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="/nats.svg" />
<link rel="stylesheet" href="/reset.css">
<link rel="stylesheet" href="/main.css">


<script async src="https://www.googletagmanager.com/gtag/js?id=G-9QV780SHZ5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-9QV780SHZ5');
</script>

  <link rel="stylesheet" type="text/css" href="/asciinema-player.css" />
</head>
<body>
  <header>
    <div class="container">
      <h1 id="header">
  <a href="/">
    <img src="/nats-horizontal-color.svg" alt="NATS Logo" /> by Example
  </a>
</h1>

    </div>
  </header>

  <main>
    <div class="container">
      <h2 class="title">Simple Leafnode <small class="quiet">in Topologies</small></h2>

      <div class="description">
      <p>This example showcases the most minimal leafnode configuration and
how clients interact.</p>

      </div>

      

      <div class="info">
        <div class="language-tabs">
          
          
          <span class="active">CLI</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Go</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Python</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Deno</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Node</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Rust</span>
          
          
          
          <span class="inactive" title="Not yet implemented">C#</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Java</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Ruby</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Elixir</span>
          
          
          
          <span class="inactive" title="Not yet implemented">C</span>
          
          
        </div>

        <div class="source-run">
          <div class="links">
            <img class="github-icon" src="/github-mark.svg" alt="GitHub Mark"/>
            <a href="https://github.com/bruth/nats-by-example/tree/main/examples/topologies/simple-leafnode/cli" target=_blank>Source code</a>
          </div>
          <pre>$ nbe run topologies/simple-leafnode/cli</pre>
          <small><a target=_blank href="https://github.com/bruth/nats-by-example/#getting-started">Learn</a> how to run this example.</small>
        </div>
      </div>

      <div class="highlight">Check out a <a href="#recording">recording</a> of the code executing and the <a href="#output">output</a> below!</div>

      <h3 id="code">Code</h3>

      <div class="example">
      
      
        <div class="example-comment">
        
        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -xeuo pipefail
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>For this example, we are going to have a service connected
to the main server and then another client send a request
via a connection to the leaf node.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="nv">NATS_MAIN_URL</span><span class="o">=</span><span class="s2">&#34;nats://0.0.0.0:4222&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">NATS_LEAF_URL</span><span class="o">=</span><span class="s2">&#34;nats://0.0.0.0:4223&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>The <code>nats</code> CLI provides a way to manage different <em>contexts</em> by name.
We save two, one for the main server and one for the leaf node.
In subsequent calls to <code>nats</code>, we can pass the <code>--context</code> option
to refer to either server.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">nats context save main <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --server <span class="s2">&#34;</span><span class="nv">$NATS_MAIN_URL</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">nats context save leaf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --server <span class="s2">&#34;</span><span class="nv">$NATS_LEAF_URL</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Create the most basic server config which enables leaf node connections.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s1">&#39;Creating the main server conf...&#39;</span>
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt;- EOF &gt; main.conf
</span></span></span><span class="line"><span class="cl"><span class="s">port: 4222
</span></span></span><span class="line"><span class="cl"><span class="s">leafnodes: {
</span></span></span><span class="line"><span class="cl"><span class="s">  port: 7422
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>The second config is for the leaf node itself. This needs to define
the leaf node <em>remotes</em> which is the main server it will be connecting
to.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s1">&#39;Creating the leaf node conf...&#39;</span>
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt;- EOF &gt; leaf.conf
</span></span></span><span class="line"><span class="cl"><span class="s">port: 4223
</span></span></span><span class="line"><span class="cl"><span class="s">leafnodes: {
</span></span></span><span class="line"><span class="cl"><span class="s">  remotes: [
</span></span></span><span class="line"><span class="cl"><span class="s">    {url: &#34;nats-leaf://0.0.0.0:7422&#34;}
</span></span></span><span class="line"><span class="cl"><span class="s">  ]
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Start the main server first.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">nats-server -c main.conf 2&gt; /dev/null <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAIN_PID</span><span class="o">=</span><span class="nv">$!</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Now we can start the leaf node which uses the credentials for the
remote connection.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">nats-server -c leaf.conf 2&gt; /dev/null <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl"><span class="nv">LEAF_PID</span><span class="o">=</span><span class="nv">$!</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Here we create a simple service which is connected via the main
server. We will put this in the background since this will block
while serving.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">nats --context main reply <span class="s1">&#39;greet&#39;</span> <span class="s1">&#39;hello from main&#39;</span> <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl"><span class="nv">SERVICE_PID</span><span class="o">=</span><span class="nv">$!</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Tiny sleep to ensure the service is connected.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Let&rsquo;s try out a request that is performed by a client connecting
to the leaf node. As expected, this will get routed to the service
connected to to the main server.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">nats --context leaf request <span class="s1">&#39;greet&#39;</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Let&rsquo;s start another service connected to the leaf node servicing
the same subject.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">nats --context leaf reply <span class="s1">&#39;greet&#39;</span> <span class="s1">&#39;hello from leaf&#39;</span> <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl"><span class="nv">SERVICE2_PID</span><span class="o">=</span><span class="nv">$!</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>NATS is smart enough to route messages to <em>closest</em> service relative
to where the client request comes from.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl">nats --context leaf request <span class="s1">&#39;greet&#39;</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">nats --context leaf request <span class="s1">&#39;greet&#39;</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">nats --context leaf request <span class="s1">&#39;greet&#39;</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>If we remove the leaf-base service, it will fallback to the main
service.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="nb">kill</span> <span class="nv">$SERVICE2_PID</span>
</span></span><span class="line"><span class="cl">nats --context leaf request <span class="s1">&#39;greet&#39;</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Finally stop the service and servers.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="nb">kill</span> <span class="nv">$SERVICE_PID</span>
</span></span><span class="line"><span class="cl"><span class="nb">kill</span> <span class="nv">$LEAF_PID</span>
</span></span><span class="line"><span class="cl"><span class="nb">kill</span> <span class="nv">$MAIN_PID</span></span></span></code></pre>
        </div>
      
      
      </div>

      <h3 id="recording">Recording</h3>
      <div class="quiet text-center">Note, playback is 1/5 the speed to make it a bit easier to follow.</div>
      <div id="asciinema"></div>

      <h3 id="output">Output</h3>

      <pre class="output">Network 048d641d_default  Creating
Network 048d641d_default  Created
             _             _               
 _ __   __ _| |_ ___      | |__   _____  __
| &#39;_ \ / _` | __/ __|_____| &#39;_ \ / _ \ \/ /
| | | | (_| | |_\__ \_____| |_) | (_) &gt;  &lt; 
|_| |_|\__,_|\__|___/     |_.__/ \___/_/\_\
                                           
nats-box v0.12.0
&#43; NATS_MAIN_URL=nats://0.0.0.0:4222
&#43; NATS_LEAF_URL=nats://0.0.0.0:4223
&#43; nats context save main --server nats://0.0.0.0:4222
NATS Configuration Context &#34;main&#34;

      Server URLs: nats://0.0.0.0:4222
             Path: /nsc/.config/nats/context/main.json

&#43; nats context save leaf --server nats://0.0.0.0:4223
NATS Configuration Context &#34;leaf&#34;

      Server URLs: nats://0.0.0.0:4223
             Path: /nsc/.config/nats/context/leaf.json

&#43; echo &#39;Creating the main server conf...&#39;
Creating the main server conf...
&#43; cat
&#43; echo &#39;Creating the leaf node conf...&#39;
Creating the leaf node conf...
&#43; cat
&#43; MAIN_PID=34
&#43; sleep 1
&#43; nats-server -c main.conf
&#43; LEAF_PID=44
&#43; sleep 1
&#43; nats-server -c leaf.conf
&#43; SERVICE_PID=54
&#43; sleep 1
&#43; nats --context main reply greet &#39;hello from main&#39;
12:12:26 Listening on &#34;greet&#34; in group &#34;NATS-RPLY-22&#34;
&#43; nats --context leaf request greet 
12:12:27 Sending request on &#34;greet&#34;


12:12:27 [#0] Received on subject &#34;greet&#34;:
12:12:27 Received with rtt 732.112µs
hello from main

&#43; SERVICE2_PID=76
&#43; nats --context leaf request greet 
&#43; nats --context leaf reply greet &#39;hello from leaf&#39;
12:12:27 Sending request on &#34;greet&#34;
12:12:27 [#1] Received on subject &#34;greet&#34;:


12:12:27 Received with rtt 3.891391ms
hello from main

12:12:27 Listening on &#34;greet&#34; in group &#34;NATS-RPLY-22&#34;
&#43; nats --context leaf request greet 
12:12:28 Sending request on &#34;greet&#34;
12:12:28 [#0] Received on subject &#34;greet&#34;:


12:12:28 Received with rtt 591.02µs
hello from leaf

&#43; nats --context leaf request greet 
12:12:28 Sending request on &#34;greet&#34;


12:12:28 [#1] Received on subject &#34;greet&#34;:
12:12:28 Received with rtt 492.585µs
hello from leaf

&#43; kill 76
&#43; nats --context leaf request greet 
12:12:28 Sending request on &#34;greet&#34;


12:12:28 [#2] Received on subject &#34;greet&#34;:
12:12:28 Received with rtt 631.337µs
hello from main

&#43; kill 54
&#43; kill 44
&#43; kill 34
</pre>

    </div>
  </main>
  <script src="/main.js" async></script>
  <script src="/asciinema-player.min.js"></script>
  <script>
    var url = '/examples\/topologies\/simple-leafnode\/cli\/output.cast';
    AsciinemaPlayer.create(url, document.getElementById('asciinema'), {
      cols: 120,
      rows: 24,
      fit: false,
      
      speed: 0.2,
      terminalFontSize: "14px",
      terminalFontFamily: "'Roboto Mono', 'JetBrains Mono', 'Source Code Pro', 'FreeMono', monospace",
      terminalFontHeight: 1.4,
    });
  </script>
  <footer>
  </footer>
</body>
</html>

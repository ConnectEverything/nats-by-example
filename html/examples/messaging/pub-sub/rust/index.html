<!doctype html>
<html>
<head>
	<title>NATS by Example</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="/nats.svg" />
<link rel="stylesheet" href="/reset.css">
<link rel="stylesheet" href="/main.css">


<script async src="https://www.googletagmanager.com/gtag/js?id=G-9QV780SHZ5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-9QV780SHZ5');
</script>

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:creator" content="@thedevel" />
  <meta name="twitter:title" content="Core Publish-Subcribe in Messaging" />
  <meta name="twitter:description" content="This example demonstrates the core NATS publish-subscribe
behavior. This is the fundamental pattern that all other NATS
patterns and higher-level APIs build upon. There are a few takeaways from this example:


Delivery is an at-most-once. For MQTT users, this is referred to as Quality of Service (QoS) 0.
There are two circumstances when a published message won&rsquo;t be delivered to a subscriber:


The subscriber does not have an active connection to the server (i.e. the client is temporarily offline for some reason)
There is a network interruption where the message is ultimately dropped

Messages are published to subjects which can be one or more concrete tokens, e.g. greet.bob. Subscribers can utilize wildcards to show interest on a set of matching subjects.

" />
  <meta name="twitter:image" content="https://natsbyexample.com/nbe-twitter.png" />
  <meta name="twitter:image:alt" content="NATS by Example" />

  <link rel="stylesheet" type="text/css" href="/asciinema-player.css" />
</head>
<body>
  <header>
    <div class="container">
      <h1 id="header">
  <a href="/">
    <img src="/nats-horizontal-color.svg" alt="NATS Logo" /> by Example
  </a>
</h1>

    </div>
  </header>

  <main>
    <div class="container">
      <h2 class="title">Core Publish-Subcribe <small class="quiet">in Messaging</small></h2>

      <div class="description">
      <p>This example demonstrates the core NATS <a href="https://docs.nats.io/nats-concepts/core-nats/pubsub">publish-subscribe</a>
behavior. This is the fundamental pattern that all other NATS
patterns and higher-level APIs build upon. There are a few takeaways from this example:</p>

<ul>
<li>Delivery is an <em>at-most-once</em>. For <a href="https://docs.nats.io/running-a-nats-service/configuration/mqtt">MQTT</a> users, this is referred to as Quality of Service (QoS) 0.</li>
<li>There are two circumstances when a published message <em>won&rsquo;t</em> be delivered to a subscriber:

<ul>
<li>The subscriber does not have an active connection to the server (i.e. the client is temporarily offline for some reason)</li>
<li>There is a network interruption where the message is ultimately dropped</li>
</ul></li>
<li>Messages are published to <a href="https://docs.nats.io/nats-concepts/subjects">subjects</a> which can be one or more concrete tokens, e.g. <code>greet.bob</code>. Subscribers can utilize <a href="https://docs.nats.io/nats-concepts/subjects#wildcards">wildcards</a> to show interest on a set of matching subjects.</li>
</ul>

      </div>

      

      <div class="info">
        <div class="language-tabs">
          
          
          <span><a href="/examples/messaging/pub-sub/cli">CLI</a></span>
          
          
          
          <span><a href="/examples/messaging/pub-sub/go">Go</a></span>
          
          
          
          <span><a href="/examples/messaging/pub-sub/python">Python</a></span>
          
          
          
          <span><a href="/examples/messaging/pub-sub/deno">Deno</a></span>
          
          
          
          <span><a href="/examples/messaging/pub-sub/node">Node</a></span>
          
          
          
          <span class="active">Rust</span>
          
          
          
          <span class="inactive" title="Not yet implemented">C#</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Java</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Ruby</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Elixir</span>
          
          
          
          <span class="inactive" title="Not yet implemented">C</span>
          
          
        </div>

        <div class="source-run">
          <div class="links">
            <img class="github-icon" src="/github-mark.svg" alt="GitHub Mark"/>
            <a href="https://github.com/bruth/nats-by-example/tree/main/examples/messaging/pub-sub/rust" target=_blank>Source code</a>
          </div>
          <pre>$ nbe run messaging/pub-sub/rust</pre>
          <small><a target=_blank href="https://github.com/bruth/nats-by-example/#getting-started">Learn</a> how to run this example.</small>
        </div>
      </div>

      <div class="highlight">Check out a <a href="#recording">recording</a> of the code executing and the <a href="#output">output</a> below!</div>

      <h3 id="code">Code</h3>

      <div class="example">
      
      
        <div class="example-comment">
        
        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">futures</span>::<span class="n">StreamExt</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="p">{</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="kt">str</span>::<span class="n">from_utf8</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[tokio::main]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">async_nats</span>::<span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span></span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Use the NATS_URL env variable if defined, otherwise fallback
to the default.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">nats_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">&#34;NATS_URL&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">unwrap_or_else</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="s">&#34;nats://localhost:4222&#34;</span><span class="p">.</span><span class="n">to_string</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async_nats</span>::<span class="n">connect</span><span class="p">(</span><span class="n">nats_url</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Publish a message to the subject <code>greet.joe</code>.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="s">&#34;greet.joe&#34;</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span><span class="w"> </span><span class="s">&#34;hello&#34;</span><span class="p">.</span><span class="n">into</span><span class="p">()).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p><code>Subscriber</code> implements Rust iterator, so we can leverage
combinators like <code>take()</code> to limit the messages intended
to be consumed for this interaction.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">subscription</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">client</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s">&#34;greet.*&#34;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()).</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Publish to three different subjects matching the wildcard.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">subject</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">[</span><span class="s">&#34;greet.sue&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;greet.bob&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;greet.pam&#34;</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">client</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">subject</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span><span class="w"> </span><span class="s">&#34;hello&#34;</span><span class="p">.</span><span class="n">into</span><span class="p">()).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Notice that the first message received is <code>greet.sue</code> and not
<code>greet.joe</code> which was the first message published. This is because
core NATS provides at-most-once quality of service (QoS). Subscribers
must be connected showing <em>interest</em> in a subject for the server to
relay the message to the client.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subscription</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="k">await</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;{:?} received on {:?}&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">from_utf8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">.</span><span class="n">payload</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="o">&amp;</span><span class="n">message</span><span class="p">.</span><span class="n">subject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre>
        </div>
      
      
      </div>

      <h3 id="recording">Recording</h3>
      <div class="quiet text-center">Note, playback is 1/5 the speed to make it a bit easier to follow.</div>
      <div id="asciinema"></div>

      <h3 id="output">Output</h3>

      <pre class="output">Network 5408da7b_default  Creating
Network 5408da7b_default  Created
Container 5408da7b-nats-1  Creating
Container 5408da7b-nats-1  Created
Container 5408da7b-nats-1  Starting
Container 5408da7b-nats-1  Started
Ok(&#34;hello&#34;) received on &#34;greet.sue&#34;
Ok(&#34;hello&#34;) received on &#34;greet.bob&#34;
Ok(&#34;hello&#34;) received on &#34;greet.pam&#34;
</pre>

    </div>
  </main>
  <script src="/main.js" async></script>
  <script src="/asciinema-player.min.js"></script>
  <script>
    var url = '/examples\/messaging\/pub-sub\/rust\/output.cast';
    AsciinemaPlayer.create(url, document.getElementById('asciinema'), {
      cols: 120,
      rows: 24,
      fit: false,
      
      speed: 0.2,
      terminalFontSize: "14px",
      terminalFontFamily: "'Roboto Mono', 'JetBrains Mono', 'Source Code Pro', 'FreeMono', monospace",
      terminalFontHeight: 1.4,
    });
  </script>
  <footer>
  </footer>
</body>
</html>

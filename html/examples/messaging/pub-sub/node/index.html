<!doctype html>
<html>
<head>
	<title>NATS by Example</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="/nats.svg" />
<link rel="stylesheet" href="/reset.css">
<link rel="stylesheet" href="/main.css">


<script async src="https://www.googletagmanager.com/gtag/js?id=G-9QV780SHZ5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-9QV780SHZ5');
</script>

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:creator" content="@thedevel" />
  <meta name="twitter:title" content="Core Publish-Subcribe in Messaging" />
  <meta name="twitter:description" content="This example demonstrates the core NATS publish-subscribe
behavior. This is the fundamental pattern that all other NATS
patterns and higher-level APIs build upon. There are a few takeaways from this example:


Delivery is an at-most-once. For MQTT users, this is referred to as Quality of Service (QoS) 0.
There are two circumstances when a published message won&rsquo;t be delivered to a subscriber:


The subscriber does not have an active connection to the server (i.e. the client is temporarily offline for some reason)
There is a network interruption where the message is ultimately dropped

Messages are published to subjects which can be one or more concrete tokens, e.g. greet.bob. Subscribers can utilize wildcards to show interest on a set of matching subjects.

" />
  <meta name="twitter:image" content="https://natsbyexample.com/nbe-twitter.png" />
  <meta name="twitter:image:alt" content="NATS by Example" />

  <link rel="stylesheet" type="text/css" href="/asciinema-player.css" />
</head>
<body>
  <header>
    <div class="container">
      <h1 id="header">
  <a href="/">
    <img src="/nats-horizontal-color.svg" alt="NATS Logo" /> by Example
  </a>
</h1>

    </div>
  </header>

  <main>
    <div class="container">
      <h2 class="title">Core Publish-Subcribe <small class="quiet">in Messaging</small></h2>

      <div class="description">
      <p>This example demonstrates the core NATS <a href="https://docs.nats.io/nats-concepts/core-nats/pubsub">publish-subscribe</a>
behavior. This is the fundamental pattern that all other NATS
patterns and higher-level APIs build upon. There are a few takeaways from this example:</p>

<ul>
<li>Delivery is an <em>at-most-once</em>. For <a href="https://docs.nats.io/running-a-nats-service/configuration/mqtt">MQTT</a> users, this is referred to as Quality of Service (QoS) 0.</li>
<li>There are two circumstances when a published message <em>won&rsquo;t</em> be delivered to a subscriber:

<ul>
<li>The subscriber does not have an active connection to the server (i.e. the client is temporarily offline for some reason)</li>
<li>There is a network interruption where the message is ultimately dropped</li>
</ul></li>
<li>Messages are published to <a href="https://docs.nats.io/nats-concepts/subjects">subjects</a> which can be one or more concrete tokens, e.g. <code>greet.bob</code>. Subscribers can utilize <a href="https://docs.nats.io/nats-concepts/subjects#wildcards">wildcards</a> to show interest on a set of matching subjects.</li>
</ul>

      </div>

      

      <div class="info">
        <div class="language-tabs">
          
          
          <span><a href="/examples/messaging/pub-sub/cli">CLI</a></span>
          
          
          
          <span><a href="/examples/messaging/pub-sub/go">Go</a></span>
          
          
          
          <span><a href="/examples/messaging/pub-sub/python">Python</a></span>
          
          
          
          <span><a href="/examples/messaging/pub-sub/deno">Deno</a></span>
          
          
          
          <span class="active">Node</span>
          
          
          
          <span><a href="/examples/messaging/pub-sub/rust">Rust</a></span>
          
          
          
          <span class="inactive" title="Not yet implemented">C#</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Java</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Ruby</span>
          
          
          
          <span class="inactive" title="Not yet implemented">Elixir</span>
          
          
          
          <span class="inactive" title="Not yet implemented">C</span>
          
          
        </div>

        <div class="source-run">
          <div class="links">
            <img class="github-icon" src="/github-mark.svg" alt="GitHub Mark"/>
            <a href="https://github.com/bruth/nats-by-example/tree/main/examples/messaging/pub-sub/node" target=_blank>Source code</a>
          </div>
          <pre>$ nbe run messaging/pub-sub/node</pre>
          <small><a target=_blank href="https://github.com/bruth/nats-by-example/#getting-started">Learn</a> how to run this example.</small>
        </div>
      </div>

      <div class="highlight">Check out a <a href="#recording">recording</a> of the code executing and the <a href="#output">output</a> below!</div>

      <h3 id="code">Code</h3>

      <div class="example">
      
      
        <div class="example-comment">
        
        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">StringCodec</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;nats&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Get the passed NATS_URL or fallback to the default. This can be
a comma-separated string.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">servers</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NATS_URL</span> <span class="o">||</span> <span class="s2">&#34;nats://localhost:4222&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Create a client connection to an available NATS server.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">nc</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">connect</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">servers</span><span class="o">:</span> <span class="nx">servers</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>NATS message payloads are byte arrays, so we need to have a codec
to serialize and deserialize payloads in order to work with them.
Another built-in codec is JSONCodec or you can implement your own.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">sc</span> <span class="o">=</span> <span class="nx">StringCodec</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>To publish a message, simply provide the <em>subject</em> of the message
and encode the message payload. NATS subjects are hierarchical using
periods as token delimiters. <code>greet</code> and <code>joe</code> are two distinct tokens.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="nx">nc</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s2">&#34;greet.bob&#34;</span><span class="p">,</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="s2">&#34;hello&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Now we are going to create a subscription and utilize a wildcard on
the second token. The effect is that this subscription shows <em>interest</em>
in all messages published to a subject with two tokens where the first
is <code>greet</code>.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">sub</span> <span class="o">=</span> <span class="nx">nc</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s2">&#34;greet.*&#34;</span><span class="p">,</span> <span class="p">{</span><span class="nx">max</span><span class="o">:</span> <span class="mi">3</span><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">done</span> <span class="o">=</span> <span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="kr">await</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">msg</span> <span class="k">of</span> <span class="nx">sub</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">sc</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span><span class="si">}</span><span class="sb"> on subject </span><span class="si">${</span><span class="nx">msg</span><span class="p">.</span><span class="nx">subject</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">})()</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Let&rsquo;s publish three more messages which will result in the messages
being forwarded to the local subscription we have.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="nx">nc</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s2">&#34;greet.joe&#34;</span><span class="p">,</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="s2">&#34;hello&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">nc</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s2">&#34;greet.pam&#34;</span><span class="p">,</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="s2">&#34;hello&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">nc</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s2">&#34;greet.sue&#34;</span><span class="p">,</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="s2">&#34;hello&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>This will wait until the above async subscription handler finishes
processing the three messages. Note that the first message to
<code>greet.bob</code> was not printed. This is because the subscription was
created <em>after</em> the publish. Core NATS provides at-most-once quality
of service (QoS) for active subscriptions.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span></code></pre>
        </div>
      
      
      
        <div class="example-comment">
        <p>Finally we drain the connection which waits for any pending
messages (published or in a subscription) to be flushed.</p>

        </div>
      
      
      
        <div class="example-code">
        <pre tabindex="0" class="chroma"><code><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">nc</span><span class="p">.</span><span class="nx">drain</span><span class="p">();</span></span></span></code></pre>
        </div>
      
      
      </div>

      <h3 id="recording">Recording</h3>
      <div class="quiet text-center">Note, playback is 1/5 the speed to make it a bit easier to follow.</div>
      <div id="asciinema"></div>

      <h3 id="output">Output</h3>

      <pre class="output">[1A[1B[0G[?25l[&#43;] Running 2/0
[34m ⠿ Network 750bdd46_default   Created                                            0.0s
[0m[34m ⠿ Container 750bdd46-nats-1  Created                                            0.0s
[0m[?25h[1A[1B[0G[?25l[&#43;] Running 0/0
[37m ⠋ Container 750bdd46-nats-1  Starting                                           0.1s
[0m[?25h[1A[1A[0G[?25l[&#43;] Running 0/1
[37m ⠙ Container 750bdd46-nats-1  Starting                                           0.2s
[0m[?25h[1A[1A[0G[?25l[34m[&#43;] Running 1/1[0m
[34m ⠿ Container 750bdd46-nats-1  Started                                            0.3s
[0m[?25hnpm ERR! Missing script: &#34;main.js&#34;
npm ERR! 
npm ERR! To see a list of scripts, run:
npm ERR!   npm run

npm ERR! A complete log of this run can be found in:
npm ERR!     /home/nats/.npm/_logs/2022-07-17T11_55_44_893Z-debug-0.log
exit status 1
</pre>

    </div>
  </main>
  <script src="/main.js" async></script>
  <script src="/asciinema-player.min.js"></script>
  <script>
    var url = '/examples\/messaging\/pub-sub\/node\/output.cast';
    AsciinemaPlayer.create(url, document.getElementById('asciinema'), {
      cols: 120,
      rows: 24,
      fit: false,
      
      speed: 0.2,
      terminalFontSize: "14px",
      terminalFontFamily: "'Roboto Mono', 'JetBrains Mono', 'Source Code Pro', 'FreeMono', monospace",
      terminalFontHeight: 1.4,
    });
  </script>
  <footer>
  </footer>
</body>
</html>
